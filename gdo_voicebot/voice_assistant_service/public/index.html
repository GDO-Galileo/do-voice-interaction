<!doctype html>
<html lang="en" dir="ltr">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link href="./stylesheets/style.css" rel="stylesheet" media="screen" charset="utf-8" type="text/css" />
  <script src="/socket.io/socket.io.js"></script>
  <script src="../../node_modules/recordrtc/RecordRTC.js"></script>
  <script src="../../node_modules/hark/hark.bundle.js"></script>
  <script src="javascripts/index.js"></script>
  <title>Voicebot Record Platform</title>
</head>

<body>
  <header>
    <h3>Voicebot Record Platform<h2>
  </header>
  <div id="controls">
    <button id="recordButton" disabled><i class="fa fa-microphone"></i></button>
    <button id="stopButton" disabled><i class="fa fa-stop"></i></button>
  </div>
  </br>
  <span id="message"></span>
  </br>
  </br>
  <span>You can use stop to cancel the record</span>
</body>
<script type="text/javascript">

  const recordButton = document.getElementById("recordButton");
  const stopButton = document.getElementById("stopButton");
  let recorder = null;
  let audioContext;
  let source;
  let audioBuffer;
  let options = {};
  var speechEvents;
  var voiceActivityDetected;
  var message = document.getElementById("message");

  const socket = io();

  function init() {
    if (!window.AudioContext) {
      if (!window.webkitAudioContext) {
        alert("Your browser does not support any AudioContext and cannot play back this audio.");
        return;
      };
      window.AudioContext = window.webkitAudioContext;
    };
    audioContext = new AudioContext();
  };

  function play(audioData) {
    source = audioContext.createBufferSource();
    audioContext.decodeAudioData(audioData, function(buffer){
        source.buffer = buffer;
        source.connect(audioContext.destination);
        source.start(0);
      },
      function(e){console.log("Error with decoding audio data" + e.err); });
  };

  socket.on("connect", function () {
    recordButton.disabled = false;
    init();
  }) 

  recordButton.onclick = function () {
    recordButton.disabled = true;
    stopButton.disabled = false;
    voiceActivityDetected = false;

    navigator.getUserMedia({
      audio: true
    }, function (stream) {
      mediaStream = stream;

      speechEvents = Hark(stream, options);

      try {
        recorder = RecordRTC(stream, {
          type: 'audio',
          mimeType: 'audio/wav',
          recorderType: StereoAudioRecorder,
          desiredSampleRate: 16000,
          numberOfAudioChannels: 1,
        });
      } catch (err) {
        alert(err.name);
      }
      message.innerHTML = "You can speak";
      recorder.startRecording();
      speechEvents.on("speaking", function () {
        voiceActivityDetected = true;
        message.innerHTML = "You're speaking ;)";
      })

      if (!stopButton.disabled) {
          speechEvents.on("stopped_speaking", function () {
            message.innerHTML = "<font color='green'>You stopped talking. Your message has been sent to the server</font>";
            recorder.stopRecording(function () {

              recorder.getDataURL(function (audioDataURL) {
                var files = {
                  audio: {
                    type: recorder.getBlob().type || 'audio/wav',
                    dataURL: audioDataURL
                  }
                };
                socket.emit("message", files);
                if (mediaStream) mediaStream.stop();
              });
            });
            recorder.clearRecordedData();
          });
          //recordButton.disabled = false;
      };
  
    }, function (error) {
      alert(JSON.stringify(error));
      console.error(JSON.stringify(error));
    });
  };
  
  stopButton.onclick = function () {
    message.innerHTML = "<font color='red'>Record cancelled</font>";
    recorder.stopRecording(function(){});
    recorder.clearRecordedData();
    stopButton.disabled = true;
    recordButton.disabled = false;
  };

  socket.on("result",function(data){
    play(data);
    recordButton.disabled = false;
    stopButton.disabled = true;
  })

</script>

</html>