<!doctype html>
<html lang="en" dir="ltr">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link href="./stylesheets/style.css" rel="stylesheet" media="screen" charset="utf-8" type="text/css" />
  <script src="/socket.io/socket.io.js"></script>
  <!-- <script src="/socket.io-stream/socket.io-stream.js"></script> -->
  <script src="../node_modules/recordrtc/RecordRTC.js"></script>
  <title>Voicebot Record Platform</title>
</head>

<body>
  <header>
    <h3>Voicebot Record Platform<h2>
  </header>
  <div id="controls">
    <button id="recordButton" disabled><i class="fa fa-microphone"></i></button>
    <button id="stopButton" disabled><i class="fa fa-stop"></i></button>
  </div>
  <span id="test"></span>
</body>
<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
<script type="text/javascript">

  const recordButton = document.getElementById("recordButton");
  const stopButton = document.getElementById("stopButton");
  let recorder;


  //var socket = io.connect("http://localhost:4000/api/echo");
  const socket = io();
  socket.on("connect", function () {
    recordButton.disabled = false;
  })

  recordButton.onclick = function () {
    recordButton.disabled = true;
    stopButton.disabled = false;

    navigator.getUserMedia({
      audio: true
    }, function (stream) {
      mediaStream = stream;

      recorder = RecorderRTC(mediaStream, {
        type: 'audio',
        mimeType: 'audio/wav',
        recorderType: StereoAudioRecorder,
        desiredSampleRate: 16000,
        numberOfAudioChannels: 1,
      });

      recorder.startRecording();
      stopButton.disabled = false;

    }, function (error) {
      alert(JSON.stringify(error));
      console.error(JSON.stringify(error));
    });
  };

  stopButton.onclick = function () {
    recordButton.disabled = false;
    stopButton.disabled = true;
  
    recorder.stopRecording(function () {
      
      var arrayBuffer = this.buffer;
      alert(arrayBuffer.byteLength);

      recorder.getDataURL(function (audioDataURL) {
        var files = {
          audio: {
            type: recorder.getBlob().type || 'audio/wav',
            dataURL: audioDataURL
          }
        };
        socket.emit("message", files);
        if (mediaStream) mediaStream.stop();
      });
    });
    /* recorder.clearRecordedData(); */
  };

  /* socket.on("message",function(data){
    var result = document.getElementById("test");
    result.innerHTML = data["msg"];
  }) */
</script>

</html>